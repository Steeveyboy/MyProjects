<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 2 Complete Verification</title>
    <link rel="stylesheet" href="css/main.css">
    <style>
        .verification-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .verification-panel {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 2px solid #4ecdc4;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            box-shadow: 0 20px 60px rgba(78, 205, 196, 0.4);
        }
        .verification-header {
            color: #4ecdc4;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.5);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: rgba(78, 205, 196, 0.1);
            border-radius: 8px;
            border-left: 4px solid #4ecdc4;
        }
        .section-title {
            color: #4ecdc4;
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .test-result {
            margin: 5px 0;
            padding: 5px 0;
            font-size: 14px;
        }
        .success { color: #51cf66; }
        .error { color: #ff6b6b; }
        .info { color: #74c0fc; }
        .warning { color: #ffd43b; }
        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #ff6b6b;
            font-size: 24px;
            cursor: pointer;
            font-weight: bold;
        }
        .demo-section {
            margin-top: 20px;
            text-align: center;
        }
        .demo-btn {
            background: #4ecdc4;
            color: #1a1a1a;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .demo-btn:hover {
            background: #45b7aa;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="verification-overlay" id="verificationOverlay">
        <div class="verification-panel">
            <button class="close-btn" onclick="closeVerification()">√ó</button>
            <div class="verification-header">üß™ Phase 2 Implementation Verification</div>
            <div id="verificationResults">Initializing verification tests...</div>
            <div class="demo-section">
                <div style="color: #4ecdc4; margin-bottom: 10px; font-weight: bold;">üéÆ Try the Features:</div>
                <button class="demo-btn" onclick="startGame()">Start Game</button>
                <button class="demo-btn" onclick="testBuyAsset()">Buy Test Asset</button>
                <button class="demo-btn" onclick="testTimeSystem()">Advance Time</button>
                <button class="demo-btn" onclick="testSaveLoad()">Test Save/Load</button>
            </div>
        </div>
    </div>
    
    <!-- Game Interface (Hidden Initially) -->
    <div class="game-container" style="display: none;" id="gameContainer">
        <div class="game-header">
            <div class="game-title">üìà Asset Manager Pro</div>
            <div class="player-stats">
                <div class="stat-item">
                    <div class="stat-value cash" id="playerCash">$50,000</div>
                    <div class="stat-label">Available Cash</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value portfolio-value" id="portfolioValue">$0</div>
                    <div class="stat-label">Portfolio Value</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value total-return" id="totalReturn">+0.00%</div>
                    <div class="stat-label">Total Return</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-value experience" id="playerLevel">Level 1</div>
                <div class="stat-label">Experience</div>
            </div>
        </div>

        <div class="market-status">
            <div class="market-indicator" id="marketIndicator">
                <span class="indicator-dot bull"></span>
                <span>Market: <span id="marketCondition">Neutral</span></span>
            </div>
            <div class="market-stats">
                <span class="market-stat">Game Date: <span id="gameDate">Loading...</span></span>
                <span class="market-stat">10Y Treasury: <span id="tenYearRate">4.25%</span></span>
                <span class="market-stat">Fed Rate: <span id="fedRate">5.00%</span></span>
            </div>
        </div>

        <div class="main-content">
            <div class="panel asset-store">
                <div class="panel-header">
                    <h2>üíº Available Assets</h2>
                </div>
                <div class="asset-list" id="assetList"></div>
            </div>

            <div class="panel portfolio">
                <div class="panel-header">
                    <h2>üìä Your Portfolio</h2>
                </div>
                <div class="portfolio-content" id="portfolioContent">
                    <div class="empty-portfolio">
                        <p>üèõÔ∏è No assets yet. Start with government bonds!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <!-- Load Scripts -->
    <script src="js/core.js"></script>
    <script src="js/assets.js"></script>
    <script src="js/portfolio.js"></script>
    <script src="js/dashboard.js"></script>

    <script>
        class Phase2Verifier {
            constructor() {
                this.results = [];
                this.gameInitialized = false;
            }

            async runVerification() {
                this.addResult('üöÄ Starting Phase 2 Verification Tests...', 'info', 'Initialization');
                
                await this.wait(100);
                await this.testFileSeparation();
                await this.testOOPArchitecture();
                await this.testTimeSystem();
                await this.testSaveLoadSystem();
                await this.testEnhancedAssets();
                await this.testPortfolioAnalytics();
                await this.testGameFunctionality();
                
                this.addResult('üéâ Phase 2 Verification Complete!', 'success', 'Summary');
                this.displayResults();
            }

            async testFileSeparation() {
                const section = 'File Structure & Separation';
                this.addResult('Testing modular file structure...', 'info', section);

                // Test if all required classes exist
                const requiredClasses = [
                    { name: 'GameEngine', file: 'core.js' },
                    { name: 'TimeSystem', file: 'core.js' },
                    { name: 'SaveManager', file: 'core.js' },
                    { name: 'BaseAsset', file: 'assets.js' },
                    { name: 'GovernmentBond', file: 'assets.js' },
                    { name: 'CorporateBond', file: 'assets.js' },
                    { name: 'AssetManager', file: 'assets.js' },
                    { name: 'PortfolioManager', file: 'portfolio.js' },
                    { name: 'Dashboard', file: 'dashboard.js' }
                ];

                let loadedClasses = 0;
                requiredClasses.forEach(cls => {
                    if (typeof window[cls.name] !== 'undefined') {
                        this.addResult(`‚úì ${cls.name} loaded from ${cls.file}`, 'success', section);
                        loadedClasses++;
                    } else {
                        this.addResult(`‚úó ${cls.name} missing from ${cls.file}`, 'error', section);
                    }
                });

                if (loadedClasses === requiredClasses.length) {
                    this.addResult(`‚úì All ${loadedClasses} classes loaded successfully`, 'success', section);
                } else {
                    this.addResult(`‚úó Only ${loadedClasses}/${requiredClasses.length} classes loaded`, 'error', section);
                }
            }

            async testOOPArchitecture() {
                const section = 'Object-Oriented Architecture';
                this.addResult('Testing OOP inheritance and polymorphism...', 'info', section);

                try {
                    // Test BaseAsset abstract class
                    this.addResult('‚úì BaseAsset abstract class exists', 'success', section);

                    // Test inheritance
                    const govBond = new GovernmentBond('TEST-GOV', 'Test Government Bond', 1000, 0.04, 10);
                    const corpBond = new CorporateBond('TEST-CORP', 'Test Corporate Bond', 1000, 0.055, 5, 'BBB', 'Technology');

                    if (govBond instanceof BaseAsset) {
                        this.addResult('‚úì GovernmentBond inherits from BaseAsset', 'success', section);
                    } else {
                        this.addResult('‚úó GovernmentBond inheritance failed', 'error', section);
                    }

                    if (corpBond instanceof BaseAsset) {
                        this.addResult('‚úì CorporateBond inherits from BaseAsset', 'success', section);
                    } else {
                        this.addResult('‚úó CorporateBond inheritance failed', 'error', section);
                    }

                    // Test polymorphic behavior
                    const mockMarket = { treasuryRate: 0.045, creditSpread: 0.02, vix: 18, inflation: 0.025 };
                    const govValue = govBond.calculateValue(null, mockMarket);
                    const corpValue = corpBond.calculateValue(null, mockMarket);

                    if (typeof govValue === 'number' && govValue > 0) {
                        this.addResult('‚úì GovernmentBond polymorphic calculateValue works', 'success', section);
                    } else {
                        this.addResult('‚úó GovernmentBond calculateValue failed', 'error', section);
                    }

                    if (typeof corpValue === 'number' && corpValue > 0) {
                        this.addResult('‚úì CorporateBond polymorphic calculateValue works', 'success', section);
                    } else {
                        this.addResult('‚úó CorporateBond calculateValue failed', 'error', section);
                    }

                } catch (error) {
                    this.addResult(`‚úó OOP architecture test failed: ${error.message}`, 'error', section);
                }
            }

            async testTimeSystem() {
                const section = 'Time System (1s = 1 game hour)';
                this.addResult('Testing time scaling and economic cycles...', 'info', section);

                try {
                    await this.initializeGame();
                    
                    if (window.gameEngine && window.gameEngine.timeSystem) {
                        const timeSystem = window.gameEngine.timeSystem;
                        
                        const gameDate = timeSystem.getGameDate();
                        this.addResult(`‚úì Game time initialized: ${gameDate.toDateString()}`, 'success', section);
                        
                        const economicPhase = timeSystem.getEconomicPhase();
                        this.addResult(`‚úì Economic phase: ${economicPhase}`, 'success', section);
                        
                        // Test time acceleration
                        const oldDate = new Date(gameDate);
                        timeSystem.accelerateTime(3600); // Add 1 hour
                        const newDate = timeSystem.getGameDate();
                        
                        if (newDate.getTime() > oldDate.getTime()) {
                            this.addResult('‚úì Time acceleration working', 'success', section);
                        } else {
                            this.addResult('‚úó Time acceleration failed', 'error', section);
                        }

                        // Test seasonal effects
                        const seasonalEffect = timeSystem.getSeasonalEffect();
                        this.addResult(`‚úì Seasonal effect calculated: ${(seasonalEffect * 100).toFixed(2)}%`, 'success', section);

                    } else {
                        this.addResult('‚úó TimeSystem not initialized', 'error', section);
                    }
                } catch (error) {
                    this.addResult(`‚úó Time system test failed: ${error.message}`, 'error', section);
                }
            }

            async testSaveLoadSystem() {
                const section = 'Persistence (LocalStorage)';
                this.addResult('Testing save/load functionality...', 'info', section);

                try {
                    if (!this.gameInitialized) await this.initializeGame();

                    if (window.gameEngine && window.gameEngine.saveManager) {
                        this.addResult('‚úì SaveManager initialized', 'success', section);

                        // Test save
                        window.gameEngine.saveGame();
                        this.addResult('‚úì Save operation completed', 'success', section);

                        // Verify save data exists
                        const saveData = localStorage.getItem('financialAssetGame');
                        if (saveData) {
                            const parsed = JSON.parse(saveData);
                            this.addResult(`‚úì Save data verified (${Object.keys(parsed).length} properties)`, 'success', section);
                            
                            // Check for key properties
                            if (parsed.player && parsed.portfolio) {
                                this.addResult('‚úì Essential game state saved', 'success', section);
                            } else {
                                this.addResult('‚úó Missing essential game state in save', 'error', section);
                            }
                        } else {
                            this.addResult('‚úó No save data found in localStorage', 'error', section);
                        }

                        // Test auto-save setup
                        if (window.gameEngine.saveManager.autoSaveInterval) {
                            this.addResult('‚úì Auto-save system active', 'success', section);
                        } else {
                            this.addResult('‚ö† Auto-save not detected', 'warning', section);
                        }

                    } else {
                        this.addResult('‚úó SaveManager not found', 'error', section);
                    }
                } catch (error) {
                    this.addResult(`‚úó Save/load test failed: ${error.message}`, 'error', section);
                }
            }

            async testEnhancedAssets() {
                const section = 'Enhanced Asset Classes';
                this.addResult('Testing corporate bonds and advanced features...', 'info', section);

                try {
                    if (!this.gameInitialized) await this.initializeGame();

                    // Test asset manager
                    const assets = window.assetManager.getAvailableAssets();
                    this.addResult(`‚úì ${assets.length} government bonds available at Level 1`, 'success', section);

                    // Test corporate bonds unlock at Level 3
                    const originalLevel = window.gameEngine.gameState.player.level;
                    window.gameEngine.gameState.player.level = 3;
                    
                    const level3Assets = window.assetManager.getAvailableAssets();
                    const corpBonds = level3Assets.filter(a => a instanceof CorporateBond);
                    
                    if (corpBonds.length > 0) {
                        this.addResult(`‚úì ${corpBonds.length} corporate bonds unlock at Level 3`, 'success', section);
                    } else {
                        this.addResult('‚úó No corporate bonds found at Level 3', 'error', section);
                    }

                    // Test corporate bond features
                    if (corpBonds.length > 0) {
                        const testBond = corpBonds[0];
                        const creditSpread = testBond.getCreditSpread(testBond.rating);
                        if (typeof creditSpread === 'number' && creditSpread > 0) {
                            this.addResult(`‚úì Credit spread calculation: ${(creditSpread * 10000).toFixed(0)} bps`, 'success', section);
                        } else {
                            this.addResult('‚úó Credit spread calculation failed', 'error', section);
                        }

                        const sectorRisk = testBond.getSectorRiskPremium(testBond.sector);
                        if (typeof sectorRisk === 'number') {
                            this.addResult(`‚úì Sector risk premium: ${(sectorRisk * 10000).toFixed(0)} bps`, 'success', section);
                        } else {
                            this.addResult('‚úó Sector risk calculation failed', 'error', section);
                        }
                    }

                    // Restore original level
                    window.gameEngine.gameState.player.level = originalLevel;

                } catch (error) {
                    this.addResult(`‚úó Enhanced assets test failed: ${error.message}`, 'error', section);
                }
            }

            async testPortfolioAnalytics() {
                const section = 'Portfolio Analytics';
                this.addResult('Testing advanced portfolio metrics...', 'info', section);

                try {
                    if (!this.gameInitialized) await this.initializeGame();

                    if (window.portfolioManager) {
                        // Test analytics methods
                        const methods = [
                            'calculateSharpeRatio',
                            'calculateVolatility', 
                            'calculateMaxDrawdown',
                            'calculateVaR',
                            'getDiversificationMetrics',
                            'generateAnalyticsReport'
                        ];

                        let methodsFound = 0;
                        methods.forEach(method => {
                            if (typeof window.portfolioManager[method] === 'function') {
                                this.addResult(`‚úì ${method} method available`, 'success', section);
                                methodsFound++;
                            } else {
                                this.addResult(`‚úó ${method} method missing`, 'error', section);
                            }
                        });

                        if (methodsFound === methods.length) {
                            this.addResult('‚úì All analytics methods implemented', 'success', section);
                        }

                        // Test analytics report generation
                        const report = window.portfolioManager.generateAnalyticsReport();
                        if (report === null) {
                            this.addResult('‚úì Empty portfolio analytics handled correctly', 'success', section);
                        } else {
                            this.addResult('‚úì Portfolio analytics report generated', 'success', section);
                        }

                        // Test portfolio history tracking
                        window.portfolioManager.recordPortfolioValue();
                        if (window.portfolioManager.portfolioHistory.length > 0) {
                            this.addResult('‚úì Portfolio history tracking works', 'success', section);
                        } else {
                            this.addResult('‚úó Portfolio history tracking failed', 'error', section);
                        }

                    } else {
                        this.addResult('‚úó PortfolioManager not found', 'error', section);
                    }
                } catch (error) {
                    this.addResult(`‚úó Portfolio analytics test failed: ${error.message}`, 'error', section);
                }
            }

            async testGameFunctionality() {
                const section = 'Game Functionality';
                this.addResult('Testing core game mechanics...', 'info', section);

                try {
                    if (!this.gameInitialized) await this.initializeGame();

                    // Test UI updates
                    window.dashboard.updateUI();
                    this.addResult('‚úì UI update system works', 'success', section);

                    // Test asset list rendering
                    window.dashboard.renderAssetList();
                    const assetList = document.getElementById('assetList');
                    if (assetList && assetList.children.length > 0) {
                        this.addResult(`‚úì Asset list rendered (${assetList.children.length} items)`, 'success', section);
                    } else {
                        this.addResult('‚úó Asset list rendering failed', 'error', section);
                    }

                    // Test portfolio rendering
                    window.portfolioManager.renderPortfolio();
                    this.addResult('‚úì Portfolio rendering system works', 'success', section);

                    // Test achievement system
                    window.gameEngine.checkAchievements();
                    this.addResult('‚úì Achievement system functional', 'success', section);

                    // Test market condition updates
                    window.dashboard.updateMarketConditions();
                    this.addResult('‚úì Market condition updates work', 'success', section);

                } catch (error) {
                    this.addResult(`‚úó Game functionality test failed: ${error.message}`, 'error', section);
                }
            }

            addResult(message, type, section) {
                this.results.push({ message, type, section, timestamp: Date.now() });
            }

            displayResults() {
                const sections = {};
                this.results.forEach(result => {
                    const sectionName = result.section || 'General';
                    if (!sections[sectionName]) sections[sectionName] = [];
                    sections[sectionName].push(result);
                });

                let html = '';
                for (const [sectionName, results] of Object.entries(sections)) {
                    html += `<div class="section">`;
                    html += `<div class="section-title">${sectionName}</div>`;
                    results.forEach(result => {
                        html += `<div class="test-result ${result.type}">${result.message}</div>`;
                    });
                    html += `</div>`;
                }

                document.getElementById('verificationResults').innerHTML = html;
            }

            async initializeGame() {
                if (this.gameInitialized) return;

                try {
                    window.gameEngine = new GameEngine();
                    window.assetManager = new AssetManager();
                    window.portfolioManager = new PortfolioManager();
                    window.dashboard = new Dashboard();
                    
                    this.gameInitialized = true;
                } catch (error) {
                    throw new Error(`Game initialization failed: ${error.message}`);
                }
            }

            wait(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Global functions for demo buttons
        async function startGame() {
            try {
                const verifier = new Phase2Verifier();
                await verifier.initializeGame();
                
                // Show game interface
                document.getElementById('gameContainer').style.display = 'block';
                document.getElementById('verificationOverlay').style.display = 'none';
                
                // Update game UI
                window.dashboard.updateUI();
                window.dashboard.renderAssetList();
                window.portfolioManager.renderPortfolio();
                
                // Update game date display
                if (window.gameEngine && window.gameEngine.timeSystem) {
                    const gameDate = window.gameEngine.timeSystem.getGameDate();
                    const gameDateEl = document.getElementById('gameDate');
                    if (gameDateEl) {
                        gameDateEl.textContent = gameDate.toLocaleDateString();
                    }
                }

                alert('‚úÖ Game started successfully! The verification panel has been closed.');
            } catch (error) {
                alert(`‚ùå Failed to start game: ${error.message}`);
            }
        }

        async function testBuyAsset() {
            try {
                if (!window.gameEngine) {
                    const verifier = new Phase2Verifier();
                    await verifier.initializeGame();
                }

                const assets = window.assetManager.getAvailableAssets();
                if (assets.length > 0) {
                    const success = window.portfolioManager.buyAsset(assets[0].id);
                    if (success) {
                        alert(`‚úÖ Successfully purchased ${assets[0].name}!`);
                    } else {
                        alert('‚ùå Purchase failed - insufficient funds or other error');
                    }
                } else {
                    alert('‚ùå No assets available for purchase');
                }
            } catch (error) {
                alert(`‚ùå Asset purchase test failed: ${error.message}`);
            }
        }

        async function testTimeSystem() {
            try {
                if (!window.gameEngine) {
                    const verifier = new Phase2Verifier();
                    await verifier.initializeGame();
                }

                const oldDate = window.gameEngine.timeSystem.getGameDate();
                window.gameEngine.timeSystem.accelerateTime(24 * 3600); // Add 1 day
                const newDate = window.gameEngine.timeSystem.getGameDate();
                
                alert(`‚úÖ Time advanced!\nFrom: ${oldDate.toDateString()}\nTo: ${newDate.toDateString()}`);
            } catch (error) {
                alert(`‚ùå Time system test failed: ${error.message}`);
            }
        }

        async function testSaveLoad() {
            try {
                if (!window.gameEngine) {
                    const verifier = new Phase2Verifier();
                    await verifier.initializeGame();
                }

                window.gameEngine.saveGame();
                const saveData = localStorage.getItem('financialAssetGame');
                
                if (saveData) {
                    const parsed = JSON.parse(saveData);
                    alert(`‚úÖ Save/Load test successful!\nSaved ${Object.keys(parsed).length} properties to localStorage`);
                } else {
                    alert('‚ùå Save test failed - no data found in localStorage');
                }
            } catch (error) {
                alert(`‚ùå Save/Load test failed: ${error.message}`);
            }
        }

        function closeVerification() {
            document.getElementById('verificationOverlay').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
        }

        // Run verification when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            const verifier = new Phase2Verifier();
            await verifier.runVerification();
        });
    </script>
</body>
</html>
